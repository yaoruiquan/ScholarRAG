# ScholarRAG 项目进展总结 - 2024.12.25

## 一、项目进展

### 1. Query Expansion（多查询检索）
- ✅ 创建 `src/query_expansion.py` 模块
- ✅ 使用 Qwen API 生成多个语义相似的查询变体
- ✅ 集成到检索流程：原始查询 → 扩展查询 → 合并去重 → Rerank

### 2. 多文件格式支持
- ✅ 创建 `src/document_loader.py` 统一文档加载器
- ✅ 支持格式：PDF, DOCX, TXT, Markdown, PPTX
- ✅ 文件类型权重：PDF(1.0) > DOCX(0.9) > TXT/MD(0.85) > PPT(0.75)

### 3. 对话记忆管理
- ✅ Prompt 模板支持对话历史 `RAG_PROMPT_WITH_HISTORY`
- ✅ 保留最近 5 轮对话（10条消息）作为上下文
- ✅ 理解代词指代等上下文信息

### 4. SQLite 聊天历史持久化
- ✅ 创建 `src/chat_db.py` 数据库模块
- ✅ 数据库表：`conversations`, `messages`
- ✅ 功能：创建/加载/重命名/删除对话
- ✅ 刷新页面后历史对话保留

### 5. 前端 UI 优化
- ✅ 修复进度条详情显示（`📊 细节：0/191 块 (0%)`）
- ✅ 历史对话始终显示（即使为空也显示 `(0)`）
- ✅ 文件列表默认收起
- ✅ 侧边栏样式优化（固定宽度、紧凑布局）
- ✅ 多文件格式上传支持

---

## 二、问题和解决方案

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 不同文件类型检索效果差异 | PPT 内容碎片化，信息密度低 | 添加文件类型权重到 Reranker |
| 刷新页面历史对话丢失 | 仅存储在内存 session_state | 使用 SQLite 持久化存储 |
| 对话无上下文关联 | 每次问答独立，无历史记忆 | 添加对话历史到 Prompt |
| 历史对话按钮点击无效 | Streamlit expander+button 布局问题 | 改用 selectbox+操作按钮方式 |

---

## 三、技术架构变化

### 当前架构
```
┌─────────────────────────────────────────────────────────┐
│                    ScholarRAG 系统                       │
├─────────────────────────────────────────────────────────┤
│  多格式文档 → document_loader.py → 文档切分             │
│  (PDF/DOCX/TXT/MD/PPTX)                                 │
│                         ↓                                │
│  bge-m3 Embedding (Ollama) → FAISS 向量数据库           │
│                         ↓                                │
│  Query Expansion (Qwen) → 多查询变体                    │
│                         ↓                                │
│  BM25 + Vector 混合检索 (权重 0.3:0.7)                   │
│                         ↓                                │
│  LLM Reranker (Qwen + 文件类型权重) → Top-15            │
│                         ↓                                │
│  Qwen LLM 生成答案 (含对话历史)                          │
│                         ↓                                │
│  SQLite 保存对话历史                                     │
└─────────────────────────────────────────────────────────┘
```

### 新增文件
| 文件 | 功能 |
|------|------|
| `src/query_expansion.py` | 查询扩展模块 |
| `src/document_loader.py` | 多格式文档加载器 |
| `src/chat_db.py` | SQLite 聊天历史数据库 |

### 配置参数
| 参数 | 值 |
|------|------|
| Embedding 模型 | bge-m3 (1024d) |
| INITIAL_TOP_K | 30 |
| RERANK_TOP_K | 15 |
| BM25 权重 | 0.3 |
| Vector 权重 | 0.7 |
| 对话历史轮数 | 5轮 (10条消息) |
| 文件类型权重 | PDF:1.0, DOCX:0.9, TXT:0.85, PPT:0.75 |

---

## 四、下一步优化方向

### P1 - 高优先级
1. **语义分块优化** - 使用 semantic chunking 替代固定大小切分
2. **多知识库联合检索** - 支持同时查询多个知识库

### P2 - 中优先级
3. **对话导出** - 支持导出对话为 Markdown/PDF
4. **知识库增量更新** - 向已有知识库添加新文档

### P3 - 低优先级
5. **多模态支持** - 支持 PDF 中的图表理解
6. **用户认证** - 支持多用户隔离

---

## 五、已解决 Bug（来自 12.24）

- ✅ 构建知识库时显示具体加载块数进度
- ✅ 历史对话管理完善（持久化存储）
